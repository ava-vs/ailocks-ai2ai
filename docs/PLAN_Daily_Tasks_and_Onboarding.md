# План реализации: Ежедневные задания и интерактивное обучение

**Версия:** 1.0
**Дата:** 2024-07-26

## 1. Концепция и цели

### 1.1. Проблема
На данный момент в проекте отсутствует система, которая бы мотивировала пользователей регулярно возвращаться и изучать функционал. Получение опыта (XP) происходит пассивно и не связано с конкретными, измеримыми целями, что снижает вовлеченность. Новые пользователи могут не понимать, с чего начать, чтобы эффективно использовать платформу.

### 1.2. Решение
Внедрить систему **ежедневных заданий (Daily Tasks)**, которая станет основой для геймификации и интерактивного обучения.

### 1.3. Ключевые цели
-   **Повышение вовлеченности:** Дать пользователям ясные и достижимые цели на каждый день.
-   **Интеграция с XP:** Напрямую связать выполнение заданий с системой эволюции Айлока, сделав прокачку более осознанной и управляемой.
-   **Обучение:** Использовать задания, чтобы в игровой форме знакомить пользователей с ключевыми функциями платформы (создание интентов, AI2AI взаимодействие и т.д.).
-   **Создание фундамента:** Эта система станет основой для будущего полноценного интерактивного онбординга для новых пользователей.

## 2. Изменения в схеме БД

Для реализации системы потребуется две новые таблицы.

### Таблица 1: `task_definitions`
Хранит определения всех возможных заданий в системе.

```sql
CREATE TABLE task_definitions (
  id VARCHAR(100) PRIMARY KEY, -- Уникальный ID, e.g., 'send_5_messages'
  name VARCHAR(255) NOT NULL, -- Название для UI, e.g., "Пообщаться в чате"
  description TEXT, -- Описание для UI, e.g., "Отправьте 5 сообщений в чат для выполнения"
  
  -- Триггер для выполнения
  event_type_trigger VARCHAR(100) NOT NULL, -- Событие из системы XP, e.g., 'chat_message_sent'
  trigger_count_goal INTEGER NOT NULL DEFAULT 1, -- Сколько раз событие должно произойти
  
  -- Награда и условия
  xp_reward INTEGER NOT NULL, -- Количество XP за выполнение
  category VARCHAR(50) DEFAULT 'daily', -- 'onboarding', 'daily', 'weekly', 'event'
  unlock_level_requirement INTEGER DEFAULT 1, -- Минимальный уровень Айлока для получения задания
  
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Таблица 2: `user_tasks`
Отслеживает прогресс выполнения заданий для каждого пользователя.

```sql
CREATE TABLE user_tasks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  task_id VARCHAR(100) REFERENCES task_definitions(id) NOT NULL,
  
  -- Статус и прогресс
  assigned_date DATE NOT NULL,
  progress_count INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'in_progress', -- 'in_progress', 'completed', 'claimed'
  
  -- Временные метки
  completed_at TIMESTAMP,
  claimed_at TIMESTAMP, -- Если награды нужно забирать вручную
  
  UNIQUE(user_id, task_id, assigned_date)
);
```
**Индексы:** Создать индексы для `user_tasks` по `(user_id, status)` и `(user_id, assigned_date)`.

## 3. План реализации (Backend)

### Шаг 1: Создание и наполнение `task_definitions`
-   Создать миграцию для новых таблиц.
-   Наполнить `task_definitions` начальным набором из 5-10 заданий, включая "онбординг" и "ежедневные".
    -   **Пример onboarding-задания:** ID: `create_first_intent`, Name: "Создайте первое намерение", `event_type_trigger`: 'intent_created', `trigger_count_goal`: 1, `xp_reward`: 50, `category`: 'onboarding'.
    -   **Пример daily-задания:** ID: `send_10_chat_messages`, Name: "Отправить 10 сообщений", `event_type_trigger`: 'chat_message_sent', `trigger_count_goal`: 10, `xp_reward`: 20, `category`: 'daily'.

### Шаг 2: Создание сервиса `DailyTaskService`
-   Создать новый сервис (или расширить `AilockService`) для управления логикой заданий.
-   **Метод `getTasksForUser(userId)`:**
    1.  Проверяет, были ли назначены задания пользователю на текущую дату в `user_tasks`.
    2.  Если нет, запускает логику назначения:
        -   Выбирает 1-2 `onboarding` задачи, если пользователь новый.
        -   Выбирает 2-3 `daily` задачи, доступные по уровню его Айлока.
        -   Создает записи в `user_tasks` для этого пользователя.
    3.  Возвращает список активных задач пользователя с их определениями.

### Шаг 3: Интеграция с системой XP (Ключевой шаг)
-   Модифицировать `AilockService.gainXp` или функцию `/.netlify/functions/ailock-gain-xp`.
-   **Новая логика после начисления базового XP:**
    1.  Получив событие (e.g., `eventType: 'chat_message_sent'`), система ищет в `user_tasks` активное задание для этого пользователя, у которого `event_type_trigger` совпадает с событием.
    2.  Если задание найдено, инкрементирует его `progress_count`.
    3.  Проверяет, `if (progress_count >= trigger_count_goal)`.
    4.  Если условие выполнено, меняет статус задания на `completed`, записывает `completed_at` и **дополнительно начисляет `xp_reward`**, вызывая `gainXp` рекурсивно или отдельной транзакцией с новым типом события (e.g., `daily_task_completed`).
    5.  Отправляет пользователю уведомление о выполнении задачи.

### Шаг 4: API эндпоинты
-   **`GET /.netlify/functions/daily-tasks`**: Новый эндпоинт, который использует `DailyTaskService.getTasksForUser` для получения списка задач текущего пользователя.

## 4. План реализации (Frontend)

### Шаг 1: Создание хука `useDailyTasks`
-   Создать хук, который делает запрос на `GET /.netlify/functions/daily-tasks`.
-   Управляет состоянием `tasks`, `loading`, `error`.
-   Подписывается на `ailock-profile-updated` или подобные события, чтобы обновлять список задач при необходимости.

### Шаг 2: Обновление UI компонентов
-   **`AilockQuickStatus.tsx` и `MyAilockPage.tsx`:**
    -   Заменить захардкоженный массив `dailyTasks` на реальные данные из хука `useDailyTasks`.
    -   Отображать название, описание и прогресс (`progress_count` / `trigger_count_goal`).
    -   Визуализировать статус: чекбокс для выполненных, прогресс-бар для тех, что в процессе.

### Шаг 3: Уведомления
-   При выполнении задачи бэкенд должен инициировать real-time уведомление.
-   Фронтенд должен отображать Toast-уведомление: "Задание '...' выполнено! +_N_ XP".

## 5. Будущее: Интерактивное обучение

Система ежедневных заданий станет идеальной базой для пошагового обучения.

-   **Этап 1 (Текущая реализация):** Для новых пользователей (уровень Айлока 1-3) система будет в первую очередь выдавать задачи с категорией `onboarding`. Это создаст "мягкий" онбординг через список задач.
-   **Этап 2 (Будущая разработка):**
    -   Создать отдельный UI-компонент `InteractiveOnboarding.tsx`.
    -   Этот компонент будет получать `onboarding` задачи и не просто показывать их списком, а вести пользователя по интерфейсу, подсвечивая нужные кнопки и поля ввода.
    -   **Пример:** Для задачи "Создайте первое намерение" онбординг-компонент может затемнить весь экран, кроме поля ввода в чате, и показать подсказку "Напишите здесь, что вы хотите сделать".

Этот план позволит итерационно внедрить важный для удержания функционал и заложит прочный фундамент для дальнейшего развития системы обучения. 