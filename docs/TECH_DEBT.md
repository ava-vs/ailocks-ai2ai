# Технический долг: Ai2Ai Network

> Последнее обновление: 2025-07-08

## 1. Нереализованные задачи из **PLAN_Ailocks_Interaction**

| ID | Описание | Приоритет | Оценка времени |
|---|---|---|---|
| TD-002 | **Header Integration** — интегрировать inbox badge (`unreadCount`) и кнопку открытия inbox в `AilockHeaderWidget.tsx` и для мобильной версии - в нижнее меню вместо неиспользуемой кнопки. | Done | 2 ч |
| TD-003 | **Auto-Clarify (30 % ready)** — подключить `autoClarifyIntent` в `netlify/functions/intents-create.ts`, отправка сообщения `clarify_intent`, если данные неполные. | Medium | 3 ч |
| TD-004 | **Значок уведомления о новых сообщениях** — в верхнем углу закладки и карточек, имеющих новые сообщения, показывать значок "красная точка". | Medium | 3 ч |

## 2. Дополнительные задачи
| TD-005 | **Интент "Совещание с онлайн протоколом** — Двухэкранный плеер совещания, на втором экране в виде html отображается корректируемый текущий результат совещания (в форме SMART задач на исполнение) на основе конекста совещания и выступений участников. | High | 3 д |


| ID | Описание | Приоритет | Оценка времени |
|---|---|---|---|

| TD-009 | **Сообщения между Айлоками** — только автор и адресат сообщения должны видеть сообщения в карточке интента | High | 0.5 д |
| TD-010 | **Real-time Task Notifications** — реализовать WebSocket/SSE поток `ailock-notification` и отображение Toast-уведомлений при завершении ежедневок. | High | 0.5 д |
| TD-011 | **InteractiveOnboarding.tsx** — разработать компонент пошагового онбординга, использующий задачи категории `onboarding` для обучения пользователя. | Medium | 2 д |
| TD-012 | **Claim Task Endpoint** — создать Netlify Function `/claim-task` + UI кнопку «Забрать награду» для заданий с ручным `claim`. | Low | 0.5 д |

## 3. Общие рекомендации
1. Каждую задачу сопровождать unit/E2E-тестами минимального покрытия.
2. Фиксировать время выполнения для последующего анализа точности оценок.
3. При закрытии задачи обязательно обновлять документацию и этот файл. 

## 4. Приоритезация текущего техдолга

_Ниже приведён сводный рейтинг задач по модели RICE (Reach × Impact ÷ Effort)._  

| Ранг | ID | Причина приоритета |
|---|---|---|
| 1 | TD-002 | Улучшает видимость AI2AI общения, напрямую влияет на retention |
| 2 | TD-003 | Повышает конверсию интентов, снижает ручной ввод |
| 3 | TD-009 | Корректная приватность сообщений, критично для trust |
| 4 | TD-010 | Немедленная обратная связь о daily-tasks, повышает engagement |

Остальные задачи остаются **Medium** или **Low** приоритета.  
Регулярный пересмотр ― 1 раз в спринт.

## 5. Будущее: Интерактивное обучение

| ID | Описание | Приоритет | Оценка времени |
|---|---|---|---|
| TD-013 | **Interactive Learning Architecture** — спроектировать поток обучения (события, состояния, API), описать в ADR-документе. | High | 1 д |
| TD-014 | **Migration: Onboarding Tasks** — добавить `onboarding_*` и `tutorial_*` в `task_definitions`, seed-скрипт. | High | 0.5 д |
| TD-015 | **Component `InteractiveOnboarding.tsx`** — MVP UI-компонента шаг-за-шагом (создание интента, отправка AI2AI, апгрейд навыка). | Medium | 2 д |
| TD-016 | **Progress Persistence & XP Hooks** — хранить прогресс в `user_tasks`, триггер `gainXp('tutorial_step_completed')`. | Medium | 1 д |
| TD-017 | **Gamified UI Enhancements** — анимации, подсказки, toast-XP во время обучения. | Low | 1 д |
| TD-018 | **Feature Flag & Analytics** — флаг `FT_INTERACTIVE_ONBOARDING`, A/B эксперимент, метрики D1/D7 retention. | Low | 0.5 д | 

### 5.1. Onboarding — Self-Intro Intent
Цель: при первом входе пользователь создаёт интент-самопрезентацию («Hi, I’m … and ищу коллаборации …»), чтобы сразу показать себя сети и протестировать основной флоу создания интента + AI2AI общения.

**Сценарий:**
1. После регистрации/первого логина фронтенд показывает wizard «Create your first Intent» (3 шага).
2. Шаг 1 — сбор минимальных данных (skills, цели, ключевые интересы). Предзаполнить из профиля, подсказки LLM (‘I’m a … specialising in …’).
3. Шаг 2 — генерация описания через `intent-extraction-service` (или voice agent). Пользователь может отредактировать.
4. Шаг 3 — подтверждение: создаётся интент через `/intents-create`, начисляется XP + ежедневка `onboarding_self_intro` завершается.
5. После создания Ailock автоматически отправляет 3 AI2AI `collaboration_proposal` сообщений подходящим Айлокам (`send_ailock_message`).
6. Toast и LevelUp-модал, если получен XP.

| ID | Описание | Приоритет | Оценка времени |
|---|---|---|---|
| TD-019 | **Self-Intro Intent Epic** — описать end-to-end flow, риски, UX mock (Figma), требования к API. | High | 0.5 д |
| TD-020 | **SelfIntroWizard.tsx** — 3-шаговый UI компонент (формы, прогресс, обработка ошибок). | High | 1 д |
| TD-021 | **DB Seed** — добавить `onboarding_self_intro` в `task_definitions`, trigger `first_intent_created`. | Medium | 0.5 д |
| TD-022 | **AI Suggestion Service** — использовать `intent-extraction-service` для автогенерации текста интента + подсказок. | Medium | 1 д |
| TD-023 | **Auto Outreach** — после создания интента, сервис `AilockMessageService` рассылает 3 сообщения подходящим Айлокам. | Medium | 1 д |
| TD-024 | **Tracking & Analytics** — event `onboarding_self_intro_completed`, метрики conversion → collaboration (GA + Supabase). | Low | 0.5 д | 

### 5.2. Группы Айлоков (Family / Team / Friends)
Позволяет пользователям объединять своих Айлоков (и/или членов семьи/коллег) в закрытые группы с ролями (owner, admin, member, guest) и совместно вести интенты и AI2AI-чат.

| ID | Описание | Приоритет | Оценка времени |
|---|---|---|---|
| TD-025 | **Group Ailocks Epic** — спецификация требований, модели доступа, user-stories, Figma UX flow. | High | 1 д |
| TD-026 | **DB Migration** — таблицы `groups`, `group_members`, `group_intents`, роли, индексы. | High | 0.5 д |
| TD-027 | **API Layer** — Netlify functions: `groups-create`, `groups-invite`, `groups-list`, `groups-chat`, ACL checks. | High | 1.5 д |
| TD-028 | **Shared Intents Logic** — расширить `intent-extraction-service` + `AilockMessageService` для групповых интентов и сообщений. | Medium | 1 д |
| TD-029 | **Frontend Components** — GroupSwitcher UI, GroupChat panel, intent filter by group, invite modal. | Medium | 2 д |
| TD-030 | **Permissions & Notifications** — role-based access control, real-time updates via SSE/WebSocket, group badges in UI. | Low | 1 д | 

## Система уведомлений

**Текущая реализация:** Long-Polling с использованием `pg_notify`.

**Проблема:** Текущая реализация long-polling создает долгоживущее соединение с базой данных для каждого активного клиента. Это эффективнее, чем короткие опросы, но не масштабируется на большое количество одновременных пользователей (10,000+). При росте пользовательской базы это может привести к исчерпанию доступных соединений к базе данных Neon, что вызовет сбои в работе системы уведомлений и, возможно, других частей приложения.

**Рекомендуемое решение:** Переход на внешний Pub/Sub сервис (например, Ably, Pusher, или аналогичный).

**План миграции:**
1.  **Выбор провайдера:** Провести анализ и выбрать подходящий Pub/Sub сервис, учитывая ценовую политику, лимиты бесплатного тарифа, простоту интеграции и надежность.
2.  **Модификация бэкенда:** Изменить логику отправки уведомлений. Вместо того чтобы полагаться на триггер `pg_notify` в базе данных, после сохранения уведомления в БД необходимо вызывать API выбранного Pub/Sub сервиса для публикации события в соответствующий канал пользователя (например, `user-123`).
3.  **Модификация фронтенда:** В хуке `useNotifications` заменить логику long-polling на подключение к Pub/Sub сервису с помощью его официального JavaScript SDK. Клиент должен будет подписываться на свой уникальный канал при аутентификации.
4.  **Очистка:** После успешной миграции удалить Netlify-функцию `notifications-long-poll.ts` и триггер `trg_notify_new_notification` из базы данных. 