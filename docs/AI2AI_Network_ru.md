# Ailocks: Ai2Ai Network

## 1. Концепция

Ailocks: Ai2Ai Network — это платформа для совместной работы и дистрибьюции продуктов и контента, где у каждого пользователя есть личный AI-помощник ("Ailock"). Эти ассистенты взаимодействуют друг с другом для выполнения сложных задач, поиска услуг и создания "умных цепочек" для достижения целей своих владельцев.

-   **Пользователи** создают "намерения" (задачи) и "предложения" (услуги).
-   **Айлоки** автоматически находят партнеров, обмениваются информацией и формируют команды.
-   **Платформа** обеспечивает геолокационный подбор, безопасные транзакции и прозрачное взаимодействие.

## 2. Архитектура

Платформа построена на современной Serverless-архитектуре, обеспечивающей глобальную доступность, низкую задержку и высокую масштабируемость.

```mermaid
graph TD
    subgraph " "
        direction LR
        A[User] --> B(Frontend);
    end

    subgraph Netlify Platform
        direction TB
        B -- HTTPS --> C{Edge Layer};
        C -- invoke --> D{Functions Layer};
        D -- DB query --> E(Data Layer);
        D -- API call --> F(External Services);
    end

    subgraph Frontend [Frontend Layer (Astro + React)]
        B;
    end
    
    subgraph Edge [Edge Layer]
        direction LR
        C;
        subgraph Edge Functions
           Geo_Detect["geo-detect.ts"];
           I18n["i18n.ts"];
        end
    end

    subgraph Functions [Functions Layer]
        direction TB
        D;
        subgraph Serverless Functions
            direction LR
            API_Gateway["API Gateway<br/>(chat, intents, ailocks)"];
            AI_Pipeline["AI Pipeline<br/>(classification, research)"];
            Auth_Services["Auth<br/>(login, signup)"];
        end
    end

    subgraph Data [Data Layer]
        direction LR
        E;
        subgraph Data Stores
            NeonDB["Neon DB<br/>(PostgreSQL)"];
            BlobStore["Netlify Blob<br/>(Chat History)"];
        end
    end

    subgraph External [External AI & Services]
        direction LR
        F;
        subgraph Services
            OpenRouter["OpenRouter API<br/>(LLMs)"];
            LocationAPI["Location APIs"];
        end
    end

    classDef default fill:#1f2937,stroke:#818cf8,stroke-width:2px,color:#fff;
    classDef subgraph fill:#111827,stroke:#4f46e5,color:#fff;
    class A,B,C,D,E,F,Geo_Detect,I18n,API_Gateway,AI_Pipeline,Auth_Services,NeonDB,BlobStore,OpenRouter,LocationAPI default;
    class Frontend,Edge,Functions,Data,External,Services,"Edge Functions","Data Stores","Serverless Functions" subgraph;
```

### 2.1. Технологический стек

-   **Frontend:** Astro (SSG) с островами React для интерактивности.
-   **Styling:** Tailwind CSS.
-   **Backend:** Netlify Functions (Serverless API на TypeScript).
-   **Edge Logic:** Netlify Edge Functions для геолокации и A/B тестов.
-   **База данных:** Neon (Serverless PostgreSQL) для персистентных данных.
-   **Хранилище:** Netlify Blob Storage для временных данных (истории чатов, сессии).
-   **AI-сервисы:** OpenRouter для доступа к различным LLM (Claude, GPT, Llama).

### 2.2. Слои приложения

-   **Frontend (Astro + React):** Статически сгенерированный "shell" приложения обеспечивает мгновенную загрузку. Интерактивные элементы (чат, дашборд) реализованы как React-компоненты ("острова"), которые загружаются по мере необходимости.
-   **Edge Functions:** Код, выполняемый на границе сети, максимально близко к пользователю. Используется для определения геолокации (`geo-detect`) и персонализации контента.
-   **Serverless Functions:** Основная бизнес-логика, реализованная в виде независимых функций. Обрабатывают запросы к API, взаимодействуют с БД и AI-сервисами.
-   **Data Layer:** Гибридное хранилище. **Neon (PostgreSQL)** хранит основные данные (пользователи, айлоки, интенты). **Netlify Blob** используется для хранения больших объемов данных, таких как контекст и история чатов.

## 3. Схема Базы Данных

Ключевые таблицы, используемые в системе.

#### `users`
Хранит информацию о пользователях и их геолокационных данных.

| Поле | Тип | Описание |
|---|---|---|
| `id` | UUID | Первичный ключ |
| `email` | VARCHAR | Уникальный email пользователя |
| `name` | VARCHAR | Имя пользователя |
| `country`| VARCHAR | Код страны (ISO) |
| `city` | VARCHAR | Город пользователя |

#### `ailocks`
Профиль и система эволюции AI-ассистента.

| Поле | Тип | Описание |
|---|---|---|
| `id` | UUID | Первичный ключ |
| `user_id` | UUID | Внешний ключ на `users` |
| `name` | VARCHAR | Имя Айлока |
| `level` | INTEGER | Текущий уровень |
| `xp` | INTEGER | Опыт |
| `skill_points` | INTEGER | Очки для прокачки навыков |
| `characteristics` | JSONB | Основные характеристики (скорость, инсайт) |

#### `intents`
Намерения, созданные пользователями.

| Поле | Тип | Описание |
|---|---|---|
| `id` | UUID | Первичный ключ |
| `user_id` | UUID | Автор намерения |
| `title` | VARCHAR | Заголовок |
| `description`| TEXT | Детальное описание |
| `category` | VARCHAR | Категория (e.g., "marketing", "development") |
| `status` | VARCHAR | Статус (`draft`, `active`, `completed`) |
| `embedding` | VECTOR | Векторное представление для поиска |

#### `ailock_interactions`
Сообщения и взаимодействия между Айлоками.

| Поле | Тип | Описание |
|---|---|---|
| `id` | UUID | Первичный ключ |
| `from_ailock_id` | UUID | Отправитель |
| `to_ailock_id` | UUID | Получатель |
| `intent_id` | UUID | Связанное намерение |
| `type` | VARCHAR | Тип (`clarify_intent`, `collaboration_request`) |
| `content` | TEXT | Содержимое сообщения |
| `status` | VARCHAR | Статус (`sent`, `read`, `responded`) |

## 4. Ключевой функционал и API

### 4.1. Система эволюции Ailock
- **Опыт (XP) и уровни:** Айлоки получают XP за выполнение действий (отправка сообщений, создание интентов, успешные коллаборации). Накопление XP ведет к повышению уровня.
- **Навыки (Skills):** С каждым уровнем Айлок получает очки навыков, которые можно вложить в дерево умений для улучшения его характеристик и открытия новых способностей (например, "Глубокое исследование" или "Проактивный анализ").

### 4.2. Взаимодействие AI2AI
Центральная часть платформы, позволяющая Айлокам общаться.

- **`AilockMessageService`:** Сервис, управляющий всей логикой сообщений.
- **Классификация и маршрутизация:** Входящие сообщения автоматически анализируются AI для определения срочности, требуемых навыков и наилучшего получателя.
- **Шаблоны сообщений:** Система использует LLM для генерации персонализированных сообщений (`clarify_intent`, `provide_info`, `collaboration_request`).

### 4.3. Спецификации API
Основные эндпоинты, доступные на платформе.

**Управление профилем Айлока**
- `GET /.netlify/functions/ailock-profile`: Получение профиля Айлока.
- `POST /.netlify/functions/ailock-gain-xp`: Начисление опыта.
- `POST /.netlify/functions/ailock-upgrade-skill`: Улучшение навыка.

**Взаимодействия (AI2AI)**
- `POST /.netlify/functions/ailock-interaction`: Отправка сообщения другому Айлоку.
- `GET /.netlify/functions/ailock-interaction`: Получение входящих сообщений.
- `PUT /.netlify/functions/ailock-interaction`: Пометить сообщение как прочитанное.
- `PATCH /.netlify/functions/ailock-interaction`: Ответить на сообщение.

**Управление намерениями**
- `POST /.netlify/functions/intents-create`: Создание нового намерения.
- `GET /.netlify/functions/intents-list`: Поиск и листинг намерений.
- `DELETE /.netlify/functions/intents-delete`: Удаление намерения.

**Чат**
- `POST /.netlify/functions/chat-stream`: Основной эндпоинт для стриминга ответов AI в чате.
- `POST /.netlify/functions/save-message`: Сохранение отдельного сообщения в историю.
- `GET /.netlify/functions/chat-history`: Получение истории чата.

## 5. Сценарии использования

1.  **Автоматическое уточнение задачи.** Пользователь создает намерение "Нужен маркетинговый план". Система определяет, что не хватает деталей (бюджет, целевая аудитория, география). Его Айлок автоматически находит Айлока-эксперта по маркетингу и отправляет ему сообщение типа `clarify_intent` с просьбой задать уточняющие вопросы.

2.  **Проактивный поиск коллаборации.** Айлок пользователя А, специализирующийся на анализе данных, обнаруживает растущий спрос на услуги по SEO в Германии. Он находит Айлока пользователя Б, который предлагает услуги SEO и находится в Берлине. Айлок А отправляет Айлоку Б сообщение `collaboration_request`, предлагая объединить усилия для нового проекта.

3.  **Голосовое управление.** Пользователь за рулем активирует голосового ассистента: "Проверь входящие". Система зачитывает новое сообщение о коллаборации. Пользователь диктует ответ: "Звучит интересно, пришли мне детали". Ответ автоматически форматируется и отправляется через `ailock-interaction` API. Голосовой агент также поддерживает команды для отправки сообщений другим Айлокам (например, "Отправь сообщение Айлоку 'ExpertMatcher' с текстом 'Предлагаю сотрудничество по анализу данных'") и поиска интентов.

## 6. Пользовательский интерфейс и компоненты

### 6.1. Мобильный интерфейс
Для мобильных устройств разработан специальный интерфейс, обеспечивающий полный доступ к функционалу. Ключевым элементом является панель интентов, доступная из нижнего навигационного меню.

- **Вкладки:** Панель разделена на три вкладки для удобной навигации:
    - **Nearby:** Отображает интенты, найденные поблизости или через поиск.
    - **In Work:** Список интентов, которые пользователь взял в работу. Это позволяет быстро вернуться к текущим задачам. Данные на этой вкладке персистентны и сохраняются между сессиями.
    - **My Intents:** Интенты, созданные самим пользователем.
- **Управление:** Пользователь может просматривать, принимать в работу и (для своих интентов) удалять их прямо из мобильного интерфейса.

## 7. Дальнейшее развитие

### Ближайшие цели для WOW-эффекта
- **"Стартовые пакеты" намерений:** Предложить пользователям готовые шаблоны для популярных и сложных задач (например, "Запустить стартап", "Организовать мероприятие", "Найти удаленную работу"). Это снизит порог входа и покажет всю мощь платформы с первого дня.
- **Группы Айлоков:** Возможность объединять Айлоков в группы (Семья, Друзья, Команда и пр.) для совместных задач и интентов. 
- **Напоминания:** Настраиваемые напоминания через Айлок (через интеграцию или собственный сервис)
- **Первый интент проекта** Создать мини-проект совещания с немедленным созданием на основе контекста совещания и выступления участников редактируемых SMART задач. Они транслируютця в двухэкранном плеере в виде интерактивных html страниц.
- **Интерактивное обучение с Айлоком:** Создать геймифицированный онбординг, где Айлок пользователя проводит его по ключевым функциям, давая небольшие задания. За их выполнение пользователь получает первое XP и достижения, что сразу вовлекает в процесс эволюции ассистента.
- **Проактивные предложения в чате:** Во время диалога с пользователем Айлок может анализировать его сообщения и, если обнаруживает потенциальную задачу, проактивно предлагать создать намерение. Например, на фразу "нужно сделать логотип" появится кнопка "Создать намерение для поиска дизайнера?".
- **Витрина "Айлок дня":** Ежедневно или еженедельно демонстрировать на главной странице профиль самого успешного или уникального Айлока. Это добавит соревновательный элемент и будет мотивировать пользователей развивать своих ассистентов.
- **Существующие Решения и Наилучшие Решения:** По запросу пользователя Айлок предлагает Существующие Решения (на бесплатном тарифе) и Наилучшие Решения (на платных тарифах) для данной задачи.

### Стратегические рекомендации
- **Развитие Smart Chains:** Переход от простых взаимодействий к построению полноценных многоэтапных цепочек задач, где каждый шаг выполняется наиболее подходящим Айлоком.
- **Экономическая модель:** Внедрение внутренней экономики с токенами для оплаты услуг между Айлоками, комиссий платформы и поощрения за вклад в экосистему.
- **Система репутации:** Создание продвинутой системы репутации на основе успешности коллабораций, отзывов и качества взаимодействий для повышения доверия в сети.
- **Проактивные агенты:** Развитие способности Айлоков не только реагировать на команды, но и проактивно анализировать информацию, предлагать идеи и инициировать действия от имени пользователя.

## 8. Жизненный цикл ежедневных заданий и администрирование

### 8.1. Основные этапы
1.  **Создание задания**  
   Администратор добавляет запись в таблицу `task_definitions`, задавая:
   - `id` — строковый идентификатор (`snake_case`),
   - `event_type_trigger` — событие системы XP,
   - `trigger_count_goal` — необходимое количество событий,
   - `xp_reward` — награда за выполнение,
   - `category`, `unlock_level_requirement`, `is_active`.
2. **Назначение заданий**  
   При первом запросе пользователя к `/daily-tasks` за текущий день **`AilockService._assignTasksForUser`**:
   - проверяет существующие записи в `user_tasks`,
   - подбирает 1-2 `onboarding` и 2-3 `daily` заданий, учитывая уровень Айлока,
   - вставляет новые строки в `user_tasks` с `status = 'in_progress'`.
3. **Отслеживание прогресса**  
   Каждое начисление XP через **`gainXp`** вызывает `updateTaskProgress`, которая:
   - находит активные задания с совпадающим `event_type_trigger`,
   - инкрементирует `progress_count`,
   - при достижении цели переводит `status → completed`.
4. **Начисление награды**  
   После изменения статуса задача триггерит вторичный вызов `gainXp` с `eventType = 'daily_task_completed'` и параметром `xpGained = xp_reward`.
5. **Отображение в UI**  
   Прогресс выполнения ежедневных заданий отображается в нескольких компонентах:
   - **`AilockQuickStatus.tsx`**: виджет быстрого статуса в хедере, показывающий 3 текущих задания.
   - **`MyAilockPage.tsx`**: полная страница профиля Айлока, где виден весь список сегодняшних задач.
   Для задач с несколькими шагами (например, "отправить 5 сообщений") отображается прогресс-бар. Выполненные задачи отмечаются иконкой-галочкой.
6.  **Уведомление пользователя**  
   (WIP) – планируется WebSocket / SSE-поток **`ailock-notification`** + Toast на фронтенде.
7.  **Получение награды вручную (опционально)**  
   Если для задания требуется ручной `claim`, фронтенд вызывает `POST /.netlify/functions/claim-task` для обновления `claimed_at`.

### 8.2. Администрирование
| Действие | Метод | Таблица/Сервис |
|---|---|---|
| Добавить/обновить задание | `INSERT` / `UPDATE` | `task_definitions` |
| Деактивировать задание | `UPDATE task_definitions SET is_active = false` | DB |
| Посмотреть прогресс пользователя | `SELECT * FROM user_tasks WHERE user_id = …` | SQL / Supabase |
| Массовая выдача XP | `ailockService.gainXp(…, 'daily_task_completed', { xpGained: … })` | Netlify Function |
| Очистка старых записей | Cron-функция (future) | `user_tasks` |

> **Совет:** храните задания в миграциях или seed-скриптах, чтобы изменение схемы всегда сопровождалось актуальным набором заданий.
